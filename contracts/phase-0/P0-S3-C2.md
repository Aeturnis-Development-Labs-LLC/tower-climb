# Contract P0-S3-C2: Text Rendering System

## Metadata
- **Contract ID**: P0-S3-C2
- **System**: Basic Rendering
- **Priority**: High
- **Estimated Time**: 30 minutes
- **Dependencies**: P0-S3-C1
- **Version**: 1.0.0

## Description
Implement a text rendering system that can display text with different fonts, sizes, and colors. This will be used for UI elements, debug display, and game text.

## UTF Test Blocks

### UTF-Block-P0-S3-C2-T1: Basic Text Rendering
```python
# Test: Text renders correctly
def test_basic_text_rendering():
    """
    Given: Text renderer with default font
    When: draw_text("Hello World", x=100, y=100, color=WHITE)
    Then:
      - Text appears at (100, 100)
      - Text is white (255, 255, 255)
      - Default font size is readable (16pt)
      - Text baseline is consistent
      - No artifacts or blurring
    """
    # Error-Tags: ['FONT_LOAD_FAILED', 'TEXT_RENDER_FAILED']
```

### UTF-Block-P0-S3-C2-T2: Font Size Support
```python
# Test: Different font sizes work
def test_font_sizes():
    """
    Given: Text renderer initialized
    When: Text drawn at sizes 12, 16, 24, 32
    Then:
      - Each size renders correctly
      - Scaling is proportional
      - Small text remains readable
      - Large text not pixelated
      - Font metrics scale properly
    """
    # Error-Tags: ['INVALID_FONT_SIZE', 'FONT_CACHE_MISS']
```

### UTF-Block-P0-S3-C2-T3: Text Alignment
```python
# Test: Text alignment options work
def test_text_alignment():
    """
    Given: Text to be rendered
    When: Alignment set to LEFT, CENTER, RIGHT
    Then:
      - LEFT: Text starts at x position
      - CENTER: Text centered on x position
      - RIGHT: Text ends at x position
      - Multiline text aligns correctly
      - Alignment is pixel-perfect
    """
    # Error-Tags: ['INVALID_ALIGNMENT', 'ALIGNMENT_CALC_ERROR']
```

### UTF-Block-P0-S3-C2-T4: Special Characters
```python
# Test: Special characters render correctly
def test_special_characters():
    """
    Given: Text with numbers and symbols
    When: "Score: 1,234! Time: 59.9s" is rendered
    Then:
      - Numbers display correctly
      - Punctuation appears properly
      - Common symbols supported (,.!?:-)
      - Consistent character spacing
      - No missing glyph boxes
    """
    # Error-Tags: ['GLYPH_NOT_FOUND', 'ENCODING_ERROR']
```

## Implementation Requirements

### Core Components
```python
# text_renderer.py
class TextRenderer:
    def __init__(self):
        """Initialize text rendering system."""
        
    def draw_text(self, text: str, x: int, y: int,
                  color: Tuple[int, int, int],
                  size: int = 16,
                  align: str = "left") -> None:
        """Draw text at position with options."""
        
    def get_text_size(self, text: str, size: int = 16) -> Tuple[int, int]:
        """Get width and height of rendered text."""
        
    def set_font(self, font_name: str) -> None:
        """Change the active font."""
        
    def preload_font_sizes(self, sizes: List[int]) -> None:
        """Preload fonts at common sizes."""

# Text alignment constants
class TextAlign:
    LEFT = "left"
    CENTER = "center"
    RIGHT = "right"
```

### Font Management
```python
# Font cache to avoid recreation
_font_cache: Dict[Tuple[str, int], pygame.font.Font] = {}

def get_font(name: str, size: int) -> pygame.font.Font:
    """Get or create font from cache."""
```

### Error Tags
- `FONT_LOAD_FAILED`: Could not load font file
- `TEXT_RENDER_FAILED`: Text rendering error
- `INVALID_FONT_SIZE`: Font size out of valid range
- `FONT_CACHE_MISS`: Font not in cache
- `INVALID_ALIGNMENT`: Unknown alignment value
- `ALIGNMENT_CALC_ERROR`: Error calculating text position
- `GLYPH_NOT_FOUND`: Character not in font
- `ENCODING_ERROR`: Text encoding issue

## DDERF Strategies

### FONT_LOAD_FAILED
1. **Detect**: pygame.font.Font() raises exception
2. **Diagnose**: Check font file exists, format supported
3. **Explain**: "Could not load font - using fallback"
4. **Resolve**: Use pygame default font
5. **Fix**: Bundle default font with game

### GLYPH_NOT_FOUND
1. **Detect**: Character renders as box/question mark
2. **Diagnose**: Check if glyph exists in font
3. **Explain**: "Character not supported by font"
4. **Resolve**: Skip character or use replacement
5. **Fix**: Use font with full character set

## Security Considerations
- Sanitize text input (no control characters)
- Limit text length to prevent overflow
- Validate alignment parameters

## Acceptance Criteria
- [ ] Text renders at correct position
- [ ] Multiple font sizes supported
- [ ] Text alignment works correctly
- [ ] Common characters display properly
- [ ] Font caching improves performance
- [ ] All UTF tests pass
- [ ] Coverage â‰¥95%