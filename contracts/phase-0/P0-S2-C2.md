# Contract P0-S2-C2: Input Handling System

## Metadata
- **Contract ID**: P0-S2-C2
- **System**: Game Loop and States
- **Priority**: High
- **Estimated Time**: 30 minutes
- **Dependencies**: P0-S1-C1, P0-S1-C2
- **Version**: 1.0.0

## Description
Implement a clean input handling system that processes keyboard events and maintains key state. The system should support both event-based (key press) and polling-based (key held) input methods.

## UTF Test Blocks

### UTF-Block-P0-S2-C2-T1: Key Press Detection
```python
# Test: Single key presses are detected
def test_key_press_detection():
    """
    Given: Input handler is initialized
    When: SPACE key is pressed and released
    Then:
      - is_key_pressed(K_SPACE) returns True for one frame
      - is_key_held(K_SPACE) returns True while held
      - is_key_released(K_SPACE) returns True on release
      - State resets after processing
    """
    # Error-Tags: ['KEY_PRESS_MISSED', 'KEY_STATE_STUCK']
```

### UTF-Block-P0-S2-C2-T2: Multiple Key Handling
```python
# Test: Multiple keys handled simultaneously
def test_multiple_key_handling():
    """
    Given: Input handler is active
    When: W and D keys are held together
    Then:
      - Both keys report as held
      - No key events are lost
      - Release of one doesn't affect other
      - All combinations work (up to 6 keys)
    """
    # Error-Tags: ['KEY_CONFLICT', 'INPUT_BUFFER_OVERFLOW']
```

### UTF-Block-P0-S2-C2-T3: Input Mapping
```python
# Test: Input actions are properly mapped
def test_input_action_mapping():
    """
    Given: Input map configured (WASD + Arrows = movement)
    When: Any mapped key is pressed
    Then:
      - get_action("move_up") returns True for W or UP
      - get_action("move_down") returns True for S or DOWN
      - Unmapped keys return False
      - Actions are state-aware (menu vs game)
    """
    # Error-Tags: ['ACTION_NOT_MAPPED', 'INVALID_KEY_CODE']
```

### UTF-Block-P0-S2-C2-T4: Event Queue Processing
```python
# Test: Event queue is processed correctly
def test_event_queue_processing():
    """
    Given: Multiple events in pygame event queue
    When: process_events() is called
    Then:
      - All keyboard events are handled
      - Events are processed in order
      - Queue is cleared after processing
      - Non-keyboard events are preserved
    """
    # Error-Tags: ['EVENT_QUEUE_FULL', 'EVENT_LOST']
```

## Implementation Requirements

### Core Components
```python
# input_handler.py
class InputHandler:
    def __init__(self):
        """Initialize input handling system."""
        
    def process_events(self, events: List[pygame.event.Event]) -> None:
        """Process pygame events."""
        
    def update(self) -> None:
        """Update key states for next frame."""
        
    def is_key_pressed(self, key: int) -> bool:
        """Check if key was just pressed this frame."""
        
    def is_key_held(self, key: int) -> bool:
        """Check if key is currently held down."""
        
    def is_key_released(self, key: int) -> bool:
        """Check if key was just released this frame."""
        
    def get_action(self, action: str) -> bool:
        """Check if mapped action is active."""

# input_map.py
class InputMap:
    def __init__(self):
        """Initialize input mapping."""
        
    def map_key_to_action(self, key: int, action: str) -> None:
        """Map a key to an action name."""
        
    def get_keys_for_action(self, action: str) -> List[int]:
        """Get all keys mapped to an action."""
```

### Error Tags
- `KEY_PRESS_MISSED`: Key press event not detected
- `KEY_STATE_STUCK`: Key stuck in pressed/held state
- `KEY_CONFLICT`: Multiple keys causing conflicts
- `INPUT_BUFFER_OVERFLOW`: Too many simultaneous inputs
- `ACTION_NOT_MAPPED`: Action has no key mapping
- `INVALID_KEY_CODE`: Invalid pygame key constant
- `EVENT_QUEUE_FULL`: Event queue exceeded capacity
- `EVENT_LOST`: Input event was dropped

## DDERF Strategies

### KEY_STATE_STUCK
1. **Detect**: Key reports held after window loses focus
2. **Diagnose**: Check for missed key up events
3. **Explain**: "Key state stuck - missed release event"
4. **Resolve**: Clear all key states on focus loss
5. **Fix**: Add focus change detection, reset states

### INPUT_BUFFER_OVERFLOW
1. **Detect**: More than X keys pressed simultaneously
2. **Diagnose**: Check for keyboard ghosting or spam
3. **Explain**: "Too many keys pressed at once"
4. **Resolve**: Ignore additional keys, keep first N
5. **Fix**: Document key limit, add warning

## Security Considerations
- Validate key codes are within valid range
- Prevent key injection attacks
- No direct execution of key-based commands

## Acceptance Criteria
- [ ] Single key presses detected accurately
- [ ] Multiple keys handled simultaneously
- [ ] Action mapping system works
- [ ] No stuck keys after focus loss
- [ ] Event queue processed efficiently
- [ ] All UTF tests pass
- [ ] Coverage â‰¥95%