# Contract P0-S1-C3: FPS Counter and Debug Display

## Metadata
- **Contract ID**: P0-S1-C3
- **System**: Window and Display
- **Priority**: High
- **Estimated Time**: 30 minutes
- **Dependencies**: P0-S1-C1, P0-S1-C2
- **Version**: 1.0.0

## Description
Implement an FPS counter and basic debug display system that shows performance metrics. The display should be toggleable and render in a corner without impacting game performance.

## UTF Test Blocks

### UTF-Block-P0-S1-C3-T1: FPS Calculation
```python
# Test: FPS counter calculates accurately
def test_fps_calculation():
    """
    Given: FPS counter tracking frame times
    When: 60 frames complete at 16.67ms each
    Then:
      - FPS shows 60 (±1)
      - Updates once per second
      - Shows rolling average, not instant
      - Minimum 3 decimal precision in timing
    """
    # Error-Tags: ['FPS_CALC_ERROR', 'UPDATE_RATE_WRONG']
```

### UTF-Block-P0-S1-C3-T2: Debug Display Rendering
```python
# Test: Debug info renders correctly
def test_debug_display_rendering():
    """
    Given: Debug display is enabled
    When: Game is running
    Then:
      - FPS appears in top-left corner
      - Text is readable (white on dark bg)
      - Background is semi-transparent
      - Text doesn't overlap game content
      - Font size is appropriate (12-14pt)
    """
    # Error-Tags: ['RENDER_POSITION_INVALID', 'TEXT_UNREADABLE']
```

### UTF-Block-P0-S1-C3-T3: Performance Impact
```python
# Test: Debug display has minimal performance impact
def test_debug_display_performance():
    """
    Given: Game running at stable 60 FPS
    When: Debug display is toggled on
    Then:
      - FPS drops by less than 1
      - No memory leaks from text rendering
      - Text surface is cached when possible
      - Update only when values change
    """
    # Error-Tags: ['PERFORMANCE_IMPACT_HIGH', 'MEMORY_LEAK_DETECTED']
```

### UTF-Block-P0-S1-C3-T4: Toggle Functionality
```python
# Test: Debug display can be toggled
def test_debug_display_toggle():
    """
    Given: Game is running
    When: F3 key is pressed
    Then:
      - Debug display toggles visibility
      - State persists between toggles
      - No crash if toggled rapidly
      - Toggle doesn't affect game state
    """
    # Error-Tags: ['TOGGLE_FAILED', 'STATE_CORRUPTION']
```

## Implementation Requirements

### Core Components
```python
# debug_display.py
class DebugDisplay:
    def __init__(self):
        """Initialize debug display system."""
        
    def update(self, dt: float) -> None:
        """Update FPS calculation."""
        
    def draw(self, surface: pygame.Surface) -> None:
        """Draw debug info to surface."""
        
    def toggle(self) -> None:
        """Toggle debug display visibility."""
        
    def is_visible(self) -> bool:
        """Check if debug display is visible."""

# fps_counter.py  
class FPSCounter:
    def __init__(self, update_interval: float = 1.0):
        """Initialize FPS counter with update interval."""
        
    def tick(self, dt: float) -> None:
        """Record frame time."""
        
    def get_fps(self) -> float:
        """Get current FPS value."""
        
    def get_frame_time(self) -> float:
        """Get average frame time in ms."""
```

### Error Tags
- `FPS_CALC_ERROR`: FPS calculation produced invalid result
- `UPDATE_RATE_WRONG`: FPS updates too fast/slow
- `RENDER_POSITION_INVALID`: Debug text rendered off-screen
- `TEXT_UNREADABLE`: Font/color makes text illegible
- `PERFORMANCE_IMPACT_HIGH`: Debug display hurts performance
- `MEMORY_LEAK_DETECTED`: Text surfaces not freed
- `TOGGLE_FAILED`: Toggle mechanism not working
- `STATE_CORRUPTION`: Toggle corrupted game state

## DDERF Strategies

### FPS_CALC_ERROR
1. **Detect**: FPS value is NaN, negative, or >1000
2. **Diagnose**: Check for divide by zero, timer overflow
3. **Explain**: "FPS calculation error - invalid frame times"
4. **Resolve**: Reset counter, use fallback value
5. **Fix**: Add validation to frame time inputs

### PERFORMANCE_IMPACT_HIGH
1. **Detect**: FPS drops >5% with debug enabled
2. **Diagnose**: Profile text rendering, check surface creation
3. **Explain**: "Debug display impacting performance"
4. **Resolve**: Cache rendered text, reduce update frequency
5. **Fix**: Pre-render common strings, use dirty rectangles

## Security Considerations
- No user input for debug text (prevent injection)
- FPS values sanitized before display
- Memory usage tracked to prevent leaks

## Acceptance Criteria
- [ ] FPS counter shows accurate values
- [ ] Updates exactly once per second
- [ ] Debug display toggles with F3
- [ ] Text is clearly readable
- [ ] Performance impact <1 FPS
- [ ] All UTF tests pass
- [ ] Coverage ≥95%