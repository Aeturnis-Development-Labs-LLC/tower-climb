# Contract P0-S1-C2: Main Game Loop

## Metadata
- **Contract ID**: P0-S1-C2
- **System**: Game Loop and States
- **Priority**: Critical
- **Estimated Time**: 45-60 minutes
- **Dependencies**: P0-S1-C1
- **Version**: 1.0.0

## Description
Implement the core game loop with proper timing, frame rate limiting, and state management foundation. The loop should handle events, update game state, and render at a consistent 60 FPS.

## UTF Test Blocks

### UTF-Block-P0-S1-C2-T1: Game Loop Execution
```python
# Test: Game loop runs at target framerate
def test_game_loop_framerate():
    """
    Given: Game loop is initialized with 60 FPS target
    When: Loop runs for 1 second
    Then:
      - Frame count is between 58-62
      - Delta time averages to ~16.67ms
      - No frames take longer than 33ms (2x target)
      - CPU usage remains reasonable (<50% single core)
    """
    # Error-Tags: ['FRAMERATE_UNSTABLE', 'TIMING_DRIFT']
```

### UTF-Block-P0-S1-C2-T2: Game Loop States
```python
# Test: Game loop handles state transitions
def test_game_loop_states():
    """
    Given: Game loop with state manager
    When: States are changed during runtime
    Then:
      - Current state receives update() calls
      - Previous state receives exit() call
      - New state receives enter() call
      - No updates during transition
    """
    # Error-Tags: ['STATE_TRANSITION_FAILED', 'STATE_UPDATE_SKIPPED']
```

### UTF-Block-P0-S1-C2-T3: Game Loop Shutdown
```python
# Test: Game loop exits cleanly
def test_game_loop_shutdown():
    """
    Given: Game loop is running
    When: Quit is requested (via event or method)
    Then:
      - Current frame completes
      - Active state receives exit() call
      - Loop terminates within 100ms
      - All resources are cleaned up
    """
    # Error-Tags: ['SHUTDOWN_TIMEOUT', 'RESOURCE_LEAK']
```

### UTF-Block-P0-S1-C2-T4: Delta Time Calculation
```python
# Test: Delta time is calculated correctly
def test_delta_time_calculation():
    """
    Given: Game loop tracking frame times
    When: Frames of varying duration occur
    Then:
      - Delta time reflects actual frame duration
      - Delta time is capped at 50ms (prevent spiral)
      - Delta time is never negative
      - Time accumulator handles remainder correctly
    """
    # Error-Tags: ['DELTA_TIME_INVALID', 'TIME_ACCUMULATOR_OVERFLOW']
```

## Implementation Requirements

### Core Components
```python
# game_loop.py
class GameLoop:
    def __init__(self, target_fps: int = 60):
        """Initialize game loop with target framerate."""
        
    def run(self) -> None:
        """Run the main game loop."""
        
    def stop(self) -> None:
        """Request loop termination."""
        
    def set_state(self, state: GameState) -> None:
        """Change active game state."""

# game_state.py
class GameState(ABC):
    @abstractmethod
    def enter(self) -> None:
        """Called when state becomes active."""
        
    @abstractmethod
    def exit(self) -> None:
        """Called when state becomes inactive."""
        
    @abstractmethod
    def update(self, dt: float) -> None:
        """Update state logic. dt in seconds."""
        
    @abstractmethod
    def draw(self, window: Window) -> None:
        """Draw state to window."""
```

### Error Tags
- `FRAMERATE_UNSTABLE`: FPS varies more than ±5 from target
- `TIMING_DRIFT`: Clock drift detected over time
- `STATE_TRANSITION_FAILED`: Error during state change
- `STATE_UPDATE_SKIPPED`: State update missed
- `SHUTDOWN_TIMEOUT`: Loop failed to terminate quickly
- `RESOURCE_LEAK`: Memory/handles not released
- `DELTA_TIME_INVALID`: Delta time calculation error
- `TIME_ACCUMULATOR_OVERFLOW`: Fixed timestep accumulator overflow

## DDERF Strategies

### FRAMERATE_UNSTABLE
1. **Detect**: Track FPS over sliding window, check variance
2. **Diagnose**: Profile frame times, identify slow operations
3. **Explain**: "Frame rate unstable - performance issue detected"
4. **Resolve**: Implement frame skipping, reduce workload
5. **Fix**: Add performance budgets per subsystem

### STATE_TRANSITION_FAILED
1. **Detect**: Exception during enter/exit methods
2. **Diagnose**: Check state initialization, resource availability
3. **Explain**: "Failed to change game state"
4. **Resolve**: Rollback to previous state, log error
5. **Fix**: Add state validation before transition

## Security Considerations
- Prevent state transitions during critical operations
- Cap delta time to prevent physics explosions
- No user input processing in this contract

## Acceptance Criteria
- [ ] Game loop maintains 60 FPS (±2)
- [ ] Delta time calculation is accurate
- [ ] State transitions work correctly
- [ ] Clean shutdown within 100ms
- [ ] No CPU spinning when idle
- [ ] All UTF tests pass
- [ ] Coverage ≥95%